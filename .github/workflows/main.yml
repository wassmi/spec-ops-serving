name: Spec-Ops CI Pipeline

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  quality-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Linting & Security Tools
        run: |
          pip install black flake8 bandit safety

      - name: Security Scan (Python Code)
        run: bandit -r src/
        
      - name: Dependency Audit
        run: safety check

  build-and-verify:
    needs: quality-gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Image
        run: docker build -t spec-ops-api:${{ github.sha }} .

      - name: Container Security Scan (Trivy)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'spec-ops-api:${{ github.sha }}'
          format: 'table'
          exit-code: '1' # Fails the build if "High" vulnerabilities are found
          severity: 'CRITICAL,HIGH'

      - name: Performance Smoke Test
        run: |
          # 1. Start the container
          docker run -d -p 8000:8000 --name ci_test spec-ops-api:test
          
          # 2. Increased Grace Period (30s) + Health Check Loop
          echo "‚è≥ Waiting for engine to initialize (30s)..."
          sleep 30 

          # 3. Warm-up & Performance Check with Verbose Error Output
          # We'll use -v to see if there's a connection error
          RESPONSE=$(curl -s -X POST http://localhost:8000/generate \
            -H "Content-Type: application/json" \
            -d '{"prompt": "The future of AI is", "k_draft": 1, "max_new_tokens": 10}')
          
          # Debug: Print the raw response so we can see it in logs
          echo "Raw API Response: $RESPONSE"
          
          TPS=$(echo $RESPONSE | jq -r '.tokens_per_second // "0.0"')
          
          echo "üìä CI Benchmark Result: $TPS TPS"

          # 4. Logic Gate with Debug Logs on Failure
          if (( $(echo "$TPS < 2.0" | bc -l) )); then
            echo "‚ùå FAILURE: Performance regression or startup error!"
            echo "--- DOCKER LOGS ---"
            docker logs ci_test
            docker stop ci_test
            exit 1
          fi

          echo "‚úÖ SUCCESS: Performance within threshold."
          docker stop ci_test