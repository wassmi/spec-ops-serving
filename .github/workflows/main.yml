name: Spec-Ops CI/CD

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  smoke-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Build API Container
        run: docker build -t spec-ops-api .

      - name: Run API Container
        run: |
          docker run -d -p 8888:8888 --name api spec-ops-api
          
      - name: Health Check & Warmup
        run: |
          echo "‚è≥ Waiting 20s for Heuristic Engine to stabilize..."
          sleep 20
          curl --retry 5 --retry-delay 5 --retry-connrefused http://localhost:8888/health || (docker logs api && exit 1)

      - name: Smoke Test Generation
        run: |
          curl -X POST http://localhost:8888/generate             -H "Content-Type: application/json"             -d '{"prompt": "The capital of France is", "max_new_tokens": 5}'

      - name: Cleanup
        if: always()
        run: docker rm -f api
